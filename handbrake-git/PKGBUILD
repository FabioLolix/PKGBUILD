# Maintainer: Fabio 'Lolix' Loli <fabio.loli@disroot.org> -> https://github.com/FabioLolix
# Contributor: graysky <graysky AT archlinux DOT us>
# Contributor: jiribb <jiribb@gmail.com>
# Contributor: David Spicer <azleifel at googlemail dot com>
# Contributor: Andrew Brouwers
# Contributor: ponsfoot <cabezon dot hashimoto at gmail dot com>
# Contributor: Stefan Husmann <stefan-husmann@t-online.de>

pkgbase=handbrake-git
pkgname=(handbrake-git handbrake-cli-git)
pkgver=1.8.1.r13.g2d3448f98
pkgrel=1
pkgdesc="Multithreaded video transcoder. Enabled: x265, nvenc, fdk-aac, qsv, vce, numa, hardened. Last stable branch"
arch=(i686 x86_64)
url="https://handbrake.fr/"
license=(GPL2)
source=("${pkgname%-git}::git+https://github.com/HandBrake/HandBrake.git#branch=1.8.x")
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/AMF-1.4.33-slim.tar.gz'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/dav1d-1.4.3.tar.bz2'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/fdk-aac-2.0.3.tar.gz'
        #'https://ffmpeg.org/releases/ffmpeg-7.0.1.tar.bz2'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/libbluray-1.3.4.tar.bz2'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/libdvdnav-6.1.1.tar.bz2'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/libdvdread-6.1.3.tar.bz2'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/libvpx-1.7.0.tar.gz'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/mfx_dispatch-1.35.tar.gz'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/nv-codec-headers-12.1.14.0.tar.gz'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/oneVPL-2023.3.1.tar.gz'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/SVT-AV1-v2.1.0.tar.gz'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/x265-snapshot-20230403-12776.tar.gz'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/x265_3.6.tar.gz'
        #'https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs/zimg-3.0.5.tar.gz')
_commondeps=(libxml2 libass libvorbis opus speex libtheora lame libjpeg-turbo
             libx264.so jansson libvpx libva numactl)
_guideps=(gst-plugins-base gtk4 libgudev)
makedepends=(git intltool python nasm wget cmake meson llvm clang cargo-c
             x264
             "${_commondeps[@]}" "${_guideps[@]}")
optdepends=('libdvdcss: for decoding encrypted DVDs'
            'intel-media-sdk: for enabling Intel QSV'
            'nvidia-utils: for Nvidia users, enable Nvidia nvenc'
            'cuda: for Nvidia users, enable Nvidia nvdec')
sha256sums=('SKIP')
options=(!lto)
#noextract=(
#    'AMF-1.4.30-slim.tar.gz'
#    'dav1d-1.3.0.tar.bz2'
#    'fdk-aac-2.0.2.tar.gz'
#    'ffmpeg-6.1.tar.bz2'
#    'libbluray-1.3.4.tar.bz2'
#    'libdvdnav-6.1.1.tar.bz2'
#    'libdvdread-6.1.3.tar.bz2'
#    'libvpx-1.7.0.tar.gz'
#    'mfx_dispatch-1.35.tar.gz'
#    'nv-codec-headers-12.1.14.0.tar.gz'
#    'oneVPL-2023.3.1.tar.gz'
#    'SVT-AV1-v1.7.0.tar.gz'
#    'x265-snapshot-20230403-12776.tar.gz'
#    'zimg-3.0.5.tar.gz'
#    )

pkgver() {
  cd "${pkgname%-git}"
  git describe --long | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
  cd "${pkgname%-git}"

  #[ -d download ] || mkdir download
  #for _tarball in ${noextract[@]}; do
  #  cp ../${_tarball} download/
  #done
}

 build() {
  cd "${pkgname%-git}"

  ./configure \
    --prefix=/usr \
    --harden \
    --enable-x265 \
    --enable-libdovi \
    --enable-numa \
    --enable-fdk-aac \
    --enable-nvdec \
    --enable-nvenc \
    --enable-qsv \
    --enable-vce

  make -C build
}

package_handbrake-git() {
  pkgdesc="Multithreaded video transcoder"
  depends=("${_commondeps[@]}" "${_guideps[@]}")
  optdepends+=('gst-plugins-good: for video previews'
               'gst-libav: for video previews')
  provides=(handbrake)
  conflicts=(handbrake)

  cd "$srcdir/handbrake/build"

  make DESTDIR="$pkgdir" install
  rm "$pkgdir/usr/bin/HandBrakeCLI"
}

package_handbrake-cli-git() {
  pkgdesc="Multithreaded video transcoder (CLI)"
  depends=("${_commondeps[@]}")
  provides=(handbrake-cli)
  conflicts=(handbrake-cli)

  cd "$srcdir/handbrake/build"
  install -D HandBrakeCLI "$pkgdir/usr/bin/HandBrakeCLI"
}
